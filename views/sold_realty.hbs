<div class="page-body">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Sold Realtys Data</h5>
                <button class="btn btn-primary px-3 py-2" id="createUserButton" data-bs-toggle="modal"
                    data-bs-target="#createUserModal">
                    Create Realty
                </button>
            </div>
            <div class="table-responsive">
                <table class="table" id="userTable">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Title</th>
                            <th scope="col">Owner Name</th>
                            <th scope="col">Location</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- سيتم ملء الجدول ديناميكيًا -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Pagination Controls -->
        <div id="paginationControls" class="d-flex justify-content-center mt-3"></div>
    </div>
</div>

<!-- نافذة إنشاء عقار جديد -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 90%;"> <!-- توسيع العرض -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel">Create New Realty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="row">
                        <!-- Title -->
                        <div class="col-md-6 mb-3">
                            <label for="newRealtyTitle" class="form-label">Title</label>
                            <input type="text" id="newRealtyTitle" class="form-control" name="newRealtyTitle" required>
                        </div>

                        <!-- Owner Name -->
                        <div class="col-md-6 mb-3">
                            <label for="newRealtyOwnerName" class="form-label">Owner Name</label>
                            <input type="text" id="newRealtyOwnerName" class="form-control" name="newRealtyOwnerName"
                                required>
                        </div>

                        <!-- Details -->
                        <div class="col-md-6 mb-3">
                            <label for="bathroomCount" class="form-label">Bathroom Count</label>
                            <input type="number" id="bathroomCount" class="form-control" name="bathroomCount" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="roomCount" class="form-label">Room Count</label>
                            <input type="number" id="roomCount" class="form-control" name="roomCount" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="area" class="form-label">Area (m²)</label>
                            <input type="number" id="area" class="form-control" name="area" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="realtyType" class="form-label">Type</label>
                            <input type="text" id="realtyType" class="form-control" name="realtyType" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="price" class="form-label">Price (EGP)</label>
                            <input type="number" id="price" class="form-control" name="price" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="features" class="form-label">Features</label>
                            <textarea id="features" class="form-control" name="features" rows="2" required></textarea>
                        </div>

                        <!-- Location -->
                        <div class="col-md-6 mb-3">
                            <label for="latitude" class="form-label">Latitude</label>
                            <input type="text" id="latitude" class="form-control" name="latitude" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="longitude" class="form-label">Longitude</label>
                            <input type="text" id="longitude" class="form-control" name="longitude" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="netShareCount" class="form-label">Net Share Count </label>
                            <input type="text" id="netShareCount" class="form-control" name="netShareCount" required>
                        </div>


                        <!-- Investment Details -->
                        <div class="col-md-6 mb-3">
                            <label for="netSharePrice" class="form-label">Net Share Price (EGP)</label>
                            <input type="number" id="netSharePrice" class="form-control" name="netSharePrice" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="downPayment" class="form-label">Down Payment (EGP)</label>
                            <input type="number" id="downPayment" class="form-control" name="downPayment" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="paymentPlan12" class="form-label">Payment Plan (12 Months) (EGP)</label>
                            <input type="number" id="paymentPlan12" class="form-control" name="paymentPlan12" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="paymentPlan18" class="form-label">Payment Plan (18 Months) (EGP)</label>
                            <input type="number" id="paymentPlan18" class="form-control" name="paymentPlan18" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="paymentPlan24" class="form-label">Payment Plan (24 Months) (EGP)</label>
                            <input type="number" id="paymentPlan24" class="form-control" name="paymentPlan24" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="serviceCharge" class="form-label">Service Charge (%)</label>
                            <input type="number" id="serviceCharge" class="form-control" name="serviceCharge" required>
                        </div>

                        <!-- رفع الصور في صف كامل -->
                        <div class="col-12 mb-3">
                            <label for="realtyImages" class="form-label">Upload Images</label>
                            <input type="file" id="images" name="images" multiple>
                        </div>
                    </div>

                    <button type="button" id="saveNewRealtyButton" class="btn btn-primary w-40">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- نافذة تعديل عقار -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 90%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit Realty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyTitle" class="form-label">Title</label>
                            <input type="text" id="editRealtyTitle" name="editRealtyTitle" class="form-control"
                                placeholder="Enter title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyOwnerName" class="form-label">Owner Name</label>
                            <input type="text" id="editRealtyOwnerName" name="editRealtyOwnerName" class="form-control"
                                placeholder="Enter owner name" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyLatitude" class="form-label">Latitude</label>
                            <input type="text" id="editRealtyLatitude" name="editRealtyLatitude" class="form-control"
                                placeholder="Enter latitude" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyLongitude" class="form-label">Longitude</label>
                            <input type="text" id="editRealtyLongitude" name="editRealtyLongitude" class="form-control"
                                placeholder="Enter longitude" required>
                        </div>
                    </div>

                    <!-- تفاصيل العقار -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyRoomCount" class="form-label">Room Count</label>
                            <input type="number" id="editRealtyRoomCount" name="editRealtyRoomCount"
                                class="form-control" placeholder="Enter room count" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyBathroomCount" class="form-label">Bathroom Count</label>
                            <input type="number" id="editRealtyBathroomCount" name="editRealtyBathroomCount"
                                class="form-control" placeholder="Enter bathroom count" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyArea" class="form-label">Area (m²)</label>
                            <input type="number" step="0.1" id="editRealtyArea" name="editRealtyArea"
                                class="form-control" placeholder="Enter area" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyType" class="form-label">Type</label>
                            <input type="text" id="editRealtyType" name="editRealtyType" class="form-control"
                                placeholder="Enter type" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyPrice" class="form-label">Price</label>
                            <input type="number" id="editRealtyPrice" name="editRealtyPrice" class="form-control"
                                placeholder="Enter price" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyFeatures" class="form-label">Features</label>
                            <textarea id="editRealtyFeatures" name="editRealtyFeatures" class="form-control"
                                placeholder="Enter features (comma separated)" required></textarea>
                        </div>
                    </div>

                    <!-- تفاصيل الاستثمار -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editInvestmentNetSharePrice" class="form-label">Net Share Price</label>
                            <input type="number" id="editInvestmentNetSharePrice" name="editInvestmentNetSharePrice"
                                class="form-control" placeholder="Enter net share price" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editInvestmentDownPayment" class="form-label">Down Payment</label>
                            <input type="number" id="editInvestmentDownPayment" name="editInvestmentDownPayment"
                                class="form-control" placeholder="Enter down payment" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editInvestmentServiceCharge" class="form-label">Service Charge</label>
                            <input type="number" id="editInvestmentServiceCharge" name="editInvestmentServiceCharge"
                                class="form-control" placeholder="Enter service charge" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editNetQuarter" class="form-label">Net Quarter</label>
                            <input type="number" id="editNetQuarter" name="editNetQuarter" class="form-control"
                                placeholder="Enter net quarter" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editNetReturn" class="form-label">Net Return</label>
                            <input type="number" id="editNetReturn" name="editNetReturn" class="form-control"
                                placeholder="Enter net return" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRealtyNetShareCount" class="form-label">Net Share Count</label>
                            <input type="text" id="editRealtyNetShareCount" name="editRealtyNetShareCount"
                                class="form-control" placeholder="Enter Net Share Count" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editRealtySaleDate" class="form-label">Sale Date</label>
                            <input type="date" id="editRealtySaleDate" name="editRealtySaleDate" class="form-control"
                                required>
                        </div>
                    </div>

                    <!-- رفع الصور -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="editImages" class="form-label">Upload Images</label>
                            <input type="file" id="editImages" name="images" class="form-control" multiple>
                        </div>
                    </div>

                    <button type="button" id="saveEditRealtyButton" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- نافذة عرض الموقع -->
<div class="modal fade" id="viewLocationModal" tabindex="-1" aria-labelledby="viewLocationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewLocationModalLabel">View Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <iframe id="locationIframe" src="" width="100%" height="450" frameborder="0" style="border:0"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- iframe لعرض الموقع -->
<div class="flex justify-center items-center">
    <iframe id="locationIframe" src="" width="360" height="270" frameborder="0" style="border:0"></iframe>
</div>

</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<script>

    $(document).ready(function () {
        $("#createUserModal .modal-content").draggable({
            handle: ".modal-header"
        });
    });

    function showToast(message, type) {
        const toastContainer = document.createElement('div');
        toastContainer.className = `toast-message ${type}`;
        toastContainer.textContent = message;
        document.body.appendChild(toastContainer);
        setTimeout(() => {
            toastContainer.classList.add('fade-out');
            setTimeout(() => {
                toastContainer.remove();
            }, 3000);
        }, 3000);
    }

    function showConfirmDialog(message, onConfirm, onCancel) {
        const confirmContainer = document.createElement('div');
        confirmContainer.className = 'confirm-dialog';

        confirmContainer.innerHTML = `
        <div class="confirm-box">
            <p>${message}</p>
            <div class="confirm-buttons">
                <button class="btn btn-danger" id="confirmYes">Yes</button>
                <button class="btn btn-primary" id="confirmNo">No</button>
            </div>
        </div>
    `;

        document.body.appendChild(confirmContainer);

        document.getElementById('confirmYes').addEventListener('click', () => {
            onConfirm();
            confirmContainer.remove();
        });

        document.getElementById('confirmNo').addEventListener('click', () => {
            if (onCancel) onCancel();
            confirmContainer.remove();
        });
    }


    document.addEventListener('DOMContentLoaded', async () => {

        const userTableBody = document.getElementById('userTableBody');
        const createUserModal = new bootstrap.Modal(document.getElementById('createUserModal'));
        const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        const paginationControls = document.getElementById('paginationControls');

        let currentPage = new URLSearchParams(window.location.search).get('page') || 1;
        currentPage = parseInt(currentPage);
        let limit = 10;

        const fetchRealtys = async (page, limit) => {
            try {
                const response = await fetch(`${BASE_URL}/admin/sold-realty?page=${page}&limit=${limit}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    showToast(errorData.message || 'Failed to fetch realty data.', 'failure');
                    return;
                }
                const data = await response.json();
                console.log(data);
                return data.data;
            } catch (error) {
                console.error('Error fetching realtys:', error);
                showToast('Failed to fetch realtys.', 'failure');
                return { data: [], total_count: 0, numberOfPages: 0 };
            }
        };

        const populateTable = (realtys, total_count, numberOfPages) => {
            userTableBody.innerHTML = '';
            let cnt = 1 + ((currentPage - 1) * limit);

            realtys.forEach((realty) => {
                const row = `
                    <tr>
                        <td>${cnt++}</td>
                        <td>${realty.title}</td>
                        <td>${realty.owner_name}</td>
                        <td>
                            ${realty.details.latitude && realty.details.longitude
                        ? `<button class="btn btn-primary px-3" onclick="viewLocation(${realty.details.longitude}, ${realty.details.latitude})">
                                View Location
                              </button>`
                        : 'N/A'
                    }
                        </td>
                        <td>
                            <button class="btn btn-primary px-4" onclick="editRealty('${realty.id}')">Edit</button>
                            <button class="btn btn-danger px-3" onclick="deleteRealty('${realty.id}')">Delete</button>
                        </td>
                    </tr>
                `;
                userTableBody.insertAdjacentHTML('beforeend', row);
            });

            updatePaginationControls(currentPage, numberOfPages);
        };

        const updatePaginationControls = (currentPage, numberOfPages) => {
            paginationControls.innerHTML = '';

            if (currentPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevButton.className = 'btn pagination-btn';
                prevButton.onclick = () => {
                    currentPage--;
                    updateURL(currentPage);
                    fetchRealtys(currentPage, limit).then((data) => populateTable(data.data, data.total_count, data.numberOfPages));
                };
                paginationControls.appendChild(prevButton);
            }

            for (let i = 1; i <= numberOfPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `btn pagination-btn ${i === currentPage ? 'active-page' : ''}`;
                pageButton.onclick = () => {
                    currentPage = i;
                    updateURL(currentPage);
                    fetchRealtys(currentPage, limit).then((data) => populateTable(data.data, data.total_count, data.numberOfPages));
                };
                paginationControls.appendChild(pageButton);
            }

            if (currentPage < numberOfPages) {
                const nextButton = document.createElement('button');
                nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextButton.className = 'btn pagination-btn';
                nextButton.onclick = () => {
                    currentPage++;
                    updateURL(currentPage);
                    fetchRealtys(currentPage, limit).then((data) => populateTable(data.data, data.total_count, data.numberOfPages));
                };
                paginationControls.appendChild(nextButton);
            }
        };

        const updateURL = (page) => {
            const url = new URL(window.location);
            url.searchParams.set('page', page);
            window.history.pushState({}, '', url);
            location.reload();
        };

        const realtys = await fetchRealtys(currentPage, limit);

        populateTable(realtys.data, realtys.total_count, realtys.numberOfPages);

        document.getElementById('saveNewRealtyButton').addEventListener('click', async function () {
            const formElement = document.getElementById('createUserForm');
            const formData = new FormData(formElement);

            formData.append('title', formElement.querySelector('[name="newRealtyTitle"]').value);
            formData.append('owner_name', formElement.querySelector('[name="newRealtyOwnerName"]').value);

            const details = {
                bathroom_count: formElement.querySelector('[name="bathroomCount"]').value,
                room_count: formElement.querySelector('[name="roomCount"]').value,
                area: formElement.querySelector('[name="area"]').value,
                type: formElement.querySelector('[name="realtyType"]').value,
                price: formElement.querySelector('[name="price"]').value,
                features: formElement.querySelector('[name="features"]').value,
                latitude: formElement.querySelector('[name="latitude"]').value,
                longitude: formElement.querySelector('[name="longitude"]').value,
                net_share_count: formElement.querySelector('[name="netShareCount"]').value,
            };
            formData.append('details', JSON.stringify(details));

            const investmentDetails = {
                net_share_price: formElement.querySelector('[name="netSharePrice"]').value,
                down_payment: formElement.querySelector('[name="downPayment"]').value,
                payment_plan: {
                    month_12: formElement.querySelector('[name="paymentPlan12"]').value,
                    month_18: formElement.querySelector('[name="paymentPlan18"]').value,
                    month_24: formElement.querySelector('[name="paymentPlan24"]').value,
                },
                service_charge: formElement.querySelector('[name="serviceCharge"]').value
            };
            formData.append('investment_details', JSON.stringify(investmentDetails));

            const imageInput = document.getElementById('images');

            if (imageInput.files.length > 0) {
                for (let i = 0; i < imageInput.files.length; i++) {
                    formData.append('images', imageInput.files[i]);
                }
            }

            try {
                const response = await fetch(`${BASE_URL}/realty/create`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                if (response.ok) {
                    showToast('Realty created successfully!', 'success');
                    console.log(result);
                } else {
                    console.error('Error:', result);
                    showToast('Error: Could not create realty.', 'failure');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error: Could not create realty.', 'failure');
            }
        });


        window.editRealty = async (id) => {
            window.location.href = `update-realty?id=${id}`;
        };

        window.deleteRealty = async (id) => {
            const isConfirmed = await showConfirmToast('Are you sure you want to delete this payment?');
            if (!isConfirmed) return;


            try {
                const response = await fetch(`${BASE_URL}/realty/delete/${id}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    showToast('Failed to delete realty.', 'failure');
                }

                showToast('Realty deleted successfully!', 'success');
                const realtys = await fetchRealtys(currentPage, limit);

                populateTable(realtys.data, realtys.total_count, realtys.numberOfPages);
            } catch (error) {
                console.error('Error deleting realty:', error);
                showToast('Failed to delete realty.', 'failure');
            }

        };



        {{!-- window.deleteRealty = async (id) => {
            showConfirmDialog('Are you sure you want to delete this realty?', async () => {
                try {
                    const response = await fetch(`${BASE_URL}/realty/delete/${id}`, {
                        method: 'DELETE',
                    });

                    if (!response.ok) {
                        showToast('Failed to delete realty.', 'failure');
                    }

                    showToast('Realty deleted successfully!', 'success');
                    const realtys = await fetchRealtys(currentPage, limit);

                    populateTable(realtys.data, realtys.total_count, realtys.numberOfPages);
                } catch (error) {
                    console.error('Error deleting realty:', error);
                    showToast('Failed to delete realty.', 'failure');
                }
            });
        }; --}}


        window.viewLocation = (latitude, longitude) => {
            const iframe = document.getElementById('locationIframe');
            iframe.src = `https://maps.google.com/maps?q=${latitude},${longitude}&z=15&output=embed`;

            const viewLocationModal = new bootstrap.Modal(document.getElementById('viewLocationModal'));
            viewLocationModal.show();
        };

    });



</script>

<style>
    .pagination-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin: 0 5px;
        border: 1px solid #ddd;
        background-color: #fff;
        color: #006A4E;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .pagination-btn:hover {
        background-color: #006A4E;
        color: #fff;
        border-color: #006A4E;
        transform: scale(1.1);
    }

    .active-page {
        background-color: #006A4E !important;
        color: #fff !important;
        border-color: #006A4E !important;
    }

    .pagination-btn i {
        font-size: 14px;
    }

    .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .confirm-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    }

    .confirm-buttons {
        margin-top: 15px;
    }

    .confirm-buttons button {
        margin: 0 10px;
        padding: 8px 20px;
    }
   
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">